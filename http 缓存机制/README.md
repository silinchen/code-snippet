# HTTP 缓存机制

Web 缓存大致可以分为：数据库缓存（redis）、服务器端缓存（代理服务器缓存、CDN 缓存）、浏览器缓存。

浏览器缓存也包含很多内容： HTTP 缓存、indexDB、cookie、localstorage 等等。

这里我们只讨论 HTTP 缓存相关内容。

浏览器缓存主要是 HTTP 协议定义的缓存机制。

可以通过 HTML 的 `meta` 标签进行控制，例如：`<META HTTP-EQUIV="Pragma" CONTENT="no-store">`，含义是让浏览器不缓存当前页面。但是代理服务器不解析 HTML 内容，一般应用广泛的是用 HTTP 头信息控制缓存。

## 术语

- **缓存命中率**：从缓存中得到数据的请求数与所有请求数的比率。理想状态是越高越好。
- **过期内容**：超过设置的有效时间，被标记为“陈旧”的内容。通常过期内容不能用于回复客户端的请求，必须重新向源服务器请求新的内容或者验证缓存的内容是否仍然准备。
- **验证**：验证缓存中的过期内容是否仍然有效，验证通过的话刷新过期时间。
- **失效**：失效就是把内容从缓存中移除。当内容发生改变时就必须移除失效的内容。



## 浏览器缓存分类

浏览器缓存分为**强缓存**和**协商缓存**，浏览器加载一个页面的简单流程如下：

1. 浏览器先根据这个资源的 HTML 头信息来判断是否命中强缓存。如果命中则直接加在缓存中的资源，并不会将请求发送到服务器。
2. 如果未命中强缓存，则浏览器会将资源加载请求发送到服务器。服务器来判断浏览器本地缓存是否失效。若可以使用，则服务器并不会返回资源信息，浏览器继续从缓存加载资源。
3. 如果未命中协商缓存，则服务器会将完整的资源返回给浏览器，浏览器加载新资源，并更新缓存。



### 强缓存

命中强缓存时，浏览器并不会将请求发送给服务器。在 Chrome 的开发者工具中看到 HTTP 的返回码是200，但是在Size列会显示为(from cache)。

![chrome-network-size-memory-cache](.\images\chrome-network-size-memory-cache.png)

怎么判断是否命中强缓存？

强缓存是利用 HTTP 的返回头中的 `Expires` 或者 `Cache-Control` 两个字段来控制的，用来表示资源的缓存时间，`Cache-Control` 与`Expires` 可以在服务端配置同时启用或者启用任意一个，同时启用的时候 `Cache-Control` 优先级高。



#### Expires

`Expires` 是 Web 服务器响应消息头字段，指定资源缓存过期时间，是服务器端的具体的时间点，`Expires=max-age + 请求时间`，需要和 `Last-modified` 结合使用。在响应 HTTP 请求时告诉浏览器在过期时间前浏览器可以直接从浏览器缓存取数据，而无需再次请求。

![chrome-network-response-headers](.\images\chrome-network-response-headers.png)